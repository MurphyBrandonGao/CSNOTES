# 30 如何做好微服务容量规划

容量规划系统的作用是**根据各个微服务部署集群的最大容量和线上实际运行的负荷，来决定各个微服务是否需要弹性扩缩容， 以及需要扩缩容多少台机器**。

可⻅，容量规划系统实施的关键在于两点:一是如何评估集群的最大容量和线上实际运行的负荷，也就是**如何做好容量评估**; 二是如何确定弹性扩缩容的时机以及机器数，也就是如**何做好调度决策**。

## 容量评估

1、选择合适的压测指标

一般在选取压测指标时，主要有两类：

一类是系统类指标，比如机器的CPU使用率、内存占用量、磁盘I/O使用率以及网卡带 宽等;

一类是服务类指标，比如接口响应的平均耗时、P999耗时、错误率；

但这些指标在实际压测时，都会存在一些问题。 系统类指标比如CPU使用率并不能直接反映出服务压测时的健康状况，有时候CPU使用率不高的时候，接口耗时也可能有问题;而有时候CPU使用率较高时，接口耗时表现依然很正常。而服务类的指标比如接口响应的平均耗时也不能精确的反映服务的实际健康状态，一个最典型的场景就是在压测时，已经出现一定比例的慢请求，而在平均耗时上并不能看出有多大变化，这时候实际服务已经处于不健康的状态了，应该停止压测了。

还可以观察接口的**慢速比**，也就是接口响应时间高于某个阈值的比例。比如压测的终止条件是Feed接口响应时间大于1s的比例超过1%。

2、压测获取单机的最大容量

集群的最大容量就是单机的最大容量 × 集群内的机器数量，所以要获得集群的最大容量，就必须获得单机的最大容量。通常有两种方式来获取单机的最大容量，一种是单机压测，一种是集群压测。

- 单机压测一般有两种方式，一种是通过日志回放等手段，模拟线上流量来对单机进行压测;一种是通过TCP-Copy的方式， 把线上机器的流量拷⻉过来对单机进行压测。

- 集群压测是对整个集群进行压测，以获取单机的最大容量。一般做法是通过不断把线上集群的节点摘除，以减少机器数的 方式，来增加线上节点单机的流量，从而达到压测的目的。

采用集群压测的方式要更合理一些，因为它是完全使用线上真实流量进行压测，获取的单机最大容量**数值更精确**。如果采用单机压测，通常为了避免产生“脏数据”，往往需要去掉一些上行的修改请求，所以不能完全模拟线上真实情况。不过使用集群压测的方式也有一个缺点，就是压测的时候会对线上用户的实际请求产生影响，如果压测出问题了，会**直接影响线上服务**，所以一般会选择在业务低峰期进行压测，最大限度减少对线上服务造成的影响。还有一点是，通常会在工作日进行压测，以便出现问题时，也能人为快速介入。

假设我们采用集群压测，不断地缩减线上节点的数量，并观察服务的慢速比指标，当慢速比达到1%时，就停止压测，这个时候就可以计算单机的最大容量了，一般做法是**用压测停止时刻的单机平均QPS作为单机的最大容量**。

3、实时获取集群的运行负荷



## 调度决策

使用水位线进行调度决策。

任意时刻的水位线就是集群的最大容量除以集群的实际运行负荷，可以实时监控集群的水位线。

安全线和水平线，当集群的水位线位于致命线以下时，就需要立即扩容，在扩容一定数量的机器后，水位线回到安全线以上并保持一段时间后，就可以进 行缩容了。

1、扩容

一般 采取按比例的方式，举个例子比如每一次扩容都增加30%的机器数量，再看扩容后的水位线是否处于致命线以上了。

2、缩容

在扩容完成后，集群的水位线保持在安全线以上一段时间后，就需要缩容，以节省机器成本。

