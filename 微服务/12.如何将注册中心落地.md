# 12 如何将注册中心落地

## 注册中心如何存储服务信息

注册中心既然是用来存储服务信息的，那么服务信息都包含哪些内容呢?

注册中心存储的服务信息一般包含三部分内容:**分组、服务名以及节点信息**，节点信息又包括节点地址和节点其他信息。 

从注册中心中获取的信息结构大致如下图所示。

![image-20230308112914984](https://typora-gao-pic.oss-cn-beijing.aliyuncs.com/image-20230308112914984.png)

具体存储的时候，一般是按照“分组-服务-节点信息”三层结构来存储，可以用下图来描述。Service代表服务的具体分组，Cluster代表服务的接口名，节点信息用KV存储。

 ![image-20230308114019204](https://typora-gao-pic.oss-cn-beijing.aliyuncs.com/image-20230308114019204.png)

注册中心具体工作包括四个流程：

- 服务提供者注册流程
- 服务提供者反注册流程
- 服务消费者查询流程
- 服务消费者订阅变更流程

## 注册中心如何工作

### 1.如何注册节点

- 首先查看要注册的节点是否在白名单内?如果不在就抛出异常，在的话继续下一步。 
- 其次要查看注册的Cluster(服务的接口名)是否存在?如果不存在就抛出异常，存在的话继续下一步。 
- 然后要检查Service(服务的分组)是否存在?如果不存在则抛出异常，存在的话继续下一步。 
- 最后将节点信息添加到对应的Service和Cluster下面的存储中。

### 2、如何反注册

- 查看Service(服务的分组)是否存在，不存在就抛出异常，存在就继续下一步。 
- 查看Cluster(服务的接口名)是否存在，不存在就抛出异常，存在就继续下一步。 
- 删除存储中Service和Cluster下对应的节点信息。
- 更新Cluster的sign值。

### 3.如何查询节点信息

- 首先从localcache(本机内存)中查找，如果没有就继续下一步。这里为什么服务消费者要把服务信息存在本机内存呢?主 要是因为服务节点信息并不总是时刻变化的，并不需要每一次服务调用都要调用注册中心获取最新的节点信息，只需要在本机内存中保留最新的服务提供者的节点列表就可以。
- 接着从snapshot(本地快照)中查找，如果没有就继续下一步。这里为什么服务消费者要在本地磁盘存储一份服务提供者 的节点信息的快照呢?这是因为服务消费者同注册中心之间的网络不一定总是可靠的，服务消费者重启时，本机内存中还 不存在服务提供者的节点信息，如果此时调用注册中心失败，那么服务消费者就拿不到服务节点信息了，也就没法调用 了。本地快照就是为了防止这种情况的发生，即使服务消费者重启后请求注册中心失败，依然可以读取本地快照，获取到 服务节点信息。

### 4.如何订阅服务变更

- 服务消费者从注册中心获取了服务的信息后，就订阅了服务的变化，会在本地保留Cluster的sign值。
- 服务消费者每隔一段时间，调用getSign()函数，从注册中心获取服务端该Cluster的sign值，并与本地保留的sign值做对 比，如果不一致，就从服务端拉取新的节点信息，并更新localcache和snapshot。