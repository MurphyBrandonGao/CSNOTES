# redis有哪些坑

## 三、主从复制有哪些坑

### 1、主从复制会丢数据吗

Redis 的主从复制是采用「异步」的方式进行的。

如果 master 突然宕机，可能存在有部分数据还未同步到 slave 的情况发生

### 2、同一个命令主从返回不同的结果

1. 3.2 以下版本，key 过期未被清理，无论哪个命令，查询 slave，均正常返回 value
2. 3.2 - 4.0.11 版本，查询数据返回 NULL，但 EXISTS 依旧返回 true
3. 4.0.11 以上版本，所有命令均已修复，过期 key 在 slave 上查询，均返回「不存在」

### 3、主从切换会导致缓存雪崩

我们假设，slave 的机器时钟比 master 走得「快」，而且是「快很多」。此时，从 slave 角度来看，Redis 中的数据存在「大量过期」。

如果此时操作「主从切换」，把 slave 提升为新的 master。它成为 master 后，就会开始大量清理过期 key，此时就会导致以下结果：

1. master 大量清理过期 key，主线程发生阻塞，无法及时处理客户端请求
2. Redis 中数据大量过期，引发缓存雪崩

### 4、master/slave大量数据不一致

Redis 的 maxmemory 可以控制整个实例的内存使用上限，超过这个上限，并且配置了淘汰策略，那么实例就开始淘汰数据。

但这里有个问题：**假设 master / slave 配置的 maxmemory 不一样，那此时就会发生数据不一致。**

例如，master 配置的 maxmemory 为 5G，而 slave 的 maxmemory 为 3G，当 Redis 中的数据超过 3G 时，slave 就会「提前」开始淘汰数据，此时主从库数据发生不一致。

