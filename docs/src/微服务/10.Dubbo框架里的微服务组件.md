# 10 Dubbo框架里的微服务组件

## 服务发布与引用

服务发布与引用三种常用方式：RESTFUL API、XML 配置以及 IDL 文件。Dubbo框架主要是使用XML配置方式。

声明服务提供者接口、服务地址、接口的协议与端口

```http
dubbo://host-ip:20880/com.alibaba.dubbo.demo.DemoService
```

## 服务注册与发现

## 服务调用

### 一次服务调用流程

![image-20230308004541167](https://typora-gao-pic.oss-cn-beijing.aliyuncs.com/image-20230308004541167.png)

首先我来解释微服务架构中各个组件分别对应到上面这张图中是如何实现。

- 服务发布与引用:对应实现是图里的Proxy服务代理层，Proxy根据客户端和服务端的接口描述，生成接口对应的客户端和 服务端的Stub，使得客户端调用服务端就像本地调用一样。
- 服务注册与发现:对应实现是图里的Registry注册中心层，Registry根据客户端和服务端的接口描述，解析成服务的URL格 式，然后调用注册中心的API，完成服务的注册和发现。
- 服务调用:对应实现是Protocol远程调用层，Protocol把客户端的本地请求转换成RPC请求。然后通过Transporter层来实现 通信，Codec层来实现协议封装，Serialization层来实现数据序列化和反序列化。
- 服务监控:对应实现层是Filter调用链层，通过在Filter调用链层中加入MonitorFilter，实现对每一次调用的拦截，在调用前 后进行埋点数据采集，上传给监控系统。
- 服务治理:对应实现层是Cluster层，负责服务节点管理、负载均衡、服务路由以及服务容错。 



再来看下微服务架构各个组件是如何串联起来组成一个完整的微服务框架的，以Dubbo框架下一次服务调用的过程为例，先来看下客户端发起调用的过程：

- 首先根据接口定义，通过Proxy层封装好的透明化接口代理，发起调用。
- 然后在通过Registry层封装好的服务发现功能，获取所有可用的服务提供者节点列表。
- 再根据Cluster层的负载均衡算法从可用的服务节点列表中选取一个节点发起服务调用，如果调用失败，根据Cluster层提供 的服务容错手段进行处理。
- 同时通过Filter层拦截调用，实现客户端的监控统计。
- 最后在Protocol层，封装成Dubbo RPC请求，发给服务端节点。 

这样的话，客户端的请求就从一个本地调用转化成一个远程RPC调用，经过服务调用框架的处理，通过网络传输到达服务端。其中服务调用框架包括通信协框架Transporter、通信协议Codec、序列化Serialization三层处理。

 服务端从网络中接收到请求后的处理过程是这样的:

- 首先在Protocol层，把网络上的请求解析成Dubbo RPC请求。 
- 然后通过Filter拦截调用，实现服务端的监控统计。
- 最后通过Proxy层的处理，把Dubbo RPC请求转化为接口的具体实现，执行调用。