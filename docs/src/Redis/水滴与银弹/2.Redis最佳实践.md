# Redis 最佳实践

从以下方面来考虑：

- 内存
- 高性能
- 高可用
- 运维
- 安全
- 资源
- 监控

## 一、如何使用 Redis 更节省内存？（内存方面）

### 1、控制key的长度

在开发业务时，你需要提前预估整个 Redis 中写入 key 的数量，如果 key 数量达到了百万级别，那么，过长的 key 名也会占用过多的内存空间。

### 2、避免存储 bigkey

除了控制 key 的长度之外，你同样需要关注 value 的大小，如果大量存储 bigkey，也会导致 Redis 内存增长过快。

除此之外，客户端在读写 bigkey 时，还有产生性能问题（下文会具体详述）。

- String：大小控制在 10KB 以下
- List/Hash/Set/ZSet：元素数量控制在1万以下

### 3、选择合适的数据类型

![图片](https://typora-gao-pic.oss-cn-beijing.aliyuncs.com/640.png)

- String、Set：尽可能存储 int 类型数据，会采用整数编码存储；
- Hash、ZSet：存储的元素数量控制在转换阈值之下，以压缩列表存储，节约内存。

### 4、把Redis当作缓存

你的应用写入到  Redis 中的数据，尽可能地都设置「过期时间」。

采用这种方案，可以让 Redis 中只保留经常访问的「热数据」，内存利用率也会比较高。

### 5、 实例设置 maxmemory + 淘汰策略

设置 maxmemory 控制内存上限

- volatile-lru / allkeys-lru：优先保留最近访问过的数据
- volatile-lfu / allkeys-lfu：优先保留访问次数最频繁的数据（4.0+版本支持）
- volatile-ttl ：优先淘汰即将过期的数据
- volatile-random / allkeys-random：随机淘汰数据

### 6、数据压缩后写入redis



## 二、如何持续发挥redis高性能（高性能方面）

### 1、避免存储 bigkey

由于 Redis 处理请求是单线程的，当你的应用在写入一个 bigkey 时，更多时间将消耗在「内存分配」上，这时操作延迟就会增加。同样地，删除一个 bigkey 在「释放内存」时，也会发生耗时。

而且，当你在读取这个 bigkey 时，也会在「网络数据传输」上花费更多时间，此时后面待执行的请求就会发生排队，Redis 性能下降。

### 2、开启lazy-free机制

如果你无法避免存储 bigkey，那么我建议你开启 Redis 的 lazy-free 机制。（4.0+版本支持）

当开启这个机制后，Redis 在删除一个 bigkey 时，释放内存的耗时操作，将会放到后台线程中去执行，这样可以在最大程度上，避免对主线程的影响。

### 3、不使用复杂度过高的命令

需要避免执行例如 SORT、SINTER、SINTERSTORE、ZUNIONSTORE、ZINTERSTORE 等聚合类命令。

对于这种聚合类操作，我建议你把它放到客户端来执行，不要让 Redis 承担太多的计算工作。

### 4、执行 O(N) 命令时，关注 N 的大小

在查询数据时，你要遵循以下原则：

1. 先查询数据元素的数量（LLEN/HLEN/SCARD/ZCARD）
2. 元素数量较少，可一次性查询全量数据
3. 元素数量非常多，分批查询数据（LRANGE/HASCAN/SSCAN/ZSCAN）

### 5、关注DEL时间复杂度

当你删除的是一个 String 类型 key 时，时间复杂度确实是 O(1)。但当你要删除的 key 是 List/Hash/Set/ZSet 类型，它的复杂度其实为 O(N)，N 代表元素个数。

**也就是说，删除一个 key，其元素数量越多，执行 DEL 也就越慢！**

### 6、批量命令代替单个命令

### 7、避免集中过期key

想要避免这种情况发生，你可以在设置过期时间时，增加一个随机时间，把这些 key 的**过期时间打散**，从而降低集中过期对主线程的影响。

### 8、使用长连接代替短连接

### 9、只使用db0

### 10、使用读写分离 + 分片集群

### 11、不开启AOF或AOF每秒刷盘

### 12、使用物理机部署redis

### 13、关闭操作系统内存大页机制

## 三、如何保证redis的可靠性（可靠性方面）

### 1、按业务线部署，资源隔离

不同的业务部署不同的Redis实例

### 2、部署主从集群

### 3、合理配置主从复制系数

### 4、配置哨兵集群，实现故障自动转移

只部署了主从节点，但故障发生时是无法自动切换的，所以，你还需要部署哨兵集群，实现故障的「自动切换」。

而且，多个哨兵节点需要分布在不同机器上，实例为奇数个，防止哨兵选举失败，影响切换时间。

## 四、日常运维

**1) 禁止使用 KEYS/FLUSHALL/FLUSHDB 命令**

执行这些命令，会长时间阻塞 Redis 主线程，危害极大，所以你必须禁止使用它。

如果确实想使用这些命令，我给你的建议是：

- SCAN 替换 KEYS
- 4.0+版本可使用 FLUSHALL/FLUSHDB ASYNC，清空数据的操作放在后台线程执行

## 五、安全性如何保证

## 六、如何预防redis问题

要想提前预防 Redis 问题，你需要做好以下两个方面：

1. 合理的资源规划
2. 完善的监控预警

